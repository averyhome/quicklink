name: Release Component to ESP Registry
on:
  push:
    tags:
      - "*"

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install idf-component-manager
        run: |
          python -m pip install --upgrade pip
          pip install idf-component-manager

      - name: Add pip executable paths to PATH
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Debug pip installation
        run: |
          echo "---- python executable ----"
          which python
          python --version

          echo "---- pip executable ----"
          which pip
          pip --version

          echo "---- pip installation locations ----"
          python - << 'EOF'
import sys, site
print("sys.executable:", sys.executable)
print("site.getusersitepackages():", site.getusersitepackages())
print("site.getsitepackages():", site.getsitepackages())
EOF

          echo "---- list bin directories ----"
          ls -al $HOME/.local/bin || echo "~/.local/bin not exist"
          ls -al /usr/local/bin || echo "/usr/local/bin not exist"

          echo "---- pip show idf-component-manager ----"
          pip show idf-component-manager || echo "Not installed"

          echo "---- find idf-component ----"
          find / -name "idf-component" 2>/dev/null | head

      - name: Upload component
        env:
          ESP_IDF_COMPONENT_API_TOKEN: ${{ secrets.ESP_COMPONENTS }}
        run: |
          idf-component upload